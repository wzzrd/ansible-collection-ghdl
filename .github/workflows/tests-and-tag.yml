name: Lint, test and tag

on: push

env:
  # Container engine configuration
  CONTAINER_ENGINE: ${{ vars.CI_CONTAINER_ENGINE || 'podman' }}
  # Version configuration (can be overridden with repository variables)
  ANSIBLE_CORE_VERSION: ${{ vars.ANSIBLE_CORE_VERSION || '2.16.13' }}
  ANSIBLE_LINT_VERSION: ${{ vars.ANSIBLE_LINT_VERSION || '24.9.2' }}
  PYTHON_VERSION: ${{ vars.PYTHON_VERSION || '3.11' }}
  # Ansible Galaxy configuration for custom servers
  ANSIBLE_GALAXY_SERVER_LIST: ${{ vars.ANSIBLE_GALAXY_SERVER_LIST }}
  ANSIBLE_GALAXY_SERVER_RH_CERTIFIED_URL: ${{ vars.ANSIBLE_GALAXY_SERVER_RH_CERTIFIED_URL }}
  ANSIBLE_GALAXY_SERVER_VALIDATED_URL: ${{ vars.ANSIBLE_GALAXY_SERVER_VALIDATED_URL }}
  ANSIBLE_GALAXY_SERVER_UPSTREAM_URL: ${{ vars.ANSIBLE_GALAXY_SERVER_UPSTREAM_URL }}
  ANSIBLE_GALAXY_SERVER_COMMUNITY_URL: ${{ vars.ANSIBLE_GALAXY_SERVER_COMMUNITY_URL }}
  ANSIBLE_GALAXY_SERVER_LOCAL_URL: ${{ vars.ANSIBLE_GALAXY_SERVER_LOCAL_URL }}
  ANSIBLE_GALAXY_SERVER_RH_CERTIFIED_TOKEN: ${{ secrets.ANSIBLE_GALAXY_SERVER_RH_CERTIFIED_TOKEN }}
  ANSIBLE_GALAXY_SERVER_VALIDATED_TOKEN: ${{ secrets.ANSIBLE_GALAXY_SERVER_VALIDATED_TOKEN }}
  ANSIBLE_GALAXY_SERVER_UPSTREAM_TOKEN: ${{ secrets.ANSIBLE_GALAXY_SERVER_UPSTREAM_TOKEN }}
  ANSIBLE_GALAXY_SERVER_COMMUNITY_TOKEN: ${{ secrets.ANSIBLE_GALAXY_SERVER_COMMUNITY_TOKEN }}
  ANSIBLE_GALAXY_SERVER_LOCAL_TOKEN: ${{ secrets.ANSIBLE_GALAXY_SERVER_LOCAL_TOKEN }}

jobs:
  lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pipx
        run: |
          python -m pip install --upgrade pip
          python -m pip install --user pipx
          python -m pipx ensurepath

      - name: Install ansible-core
        run: |
          pipx install ansible-core==${{ env.ANSIBLE_CORE_VERSION }}

      - name: Install ansible-lint
        run: |
          pipx inject --include-apps ansible-core ansible-lint==${{ env.ANSIBLE_LINT_VERSION }}

      - name: Verify installation
        run: |
          ansible --version
          ansible-lint --version

      - name: Run ansible-lint
        run: ansible-lint -v

  pytest:
    name: Unit Tests (pytest)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install test dependencies
        run: pip install -r tests/requirements.txt

      - name: Run pytest
        run: pytest tests/unit/ -v --tb=short --color=yes
        env:
          PYTHONPATH: ${{ github.workspace }}

  molecule:
    name: Integration Tests (Molecule)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        role:
          - starship
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: ansible_collections/wzzrd/ghdl

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Detect and setup container engine
        id: container-engine
        run: |
          ENGINE="${{ env.CONTAINER_ENGINE }}"

          # Auto-detect if not set or set to 'auto'
          if [ "$ENGINE" = "auto" ] || [ -z "$ENGINE" ]; then
            if command -v podman &> /dev/null; then
              ENGINE="podman"
            elif command -v docker &> /dev/null; then
              ENGINE="docker"
            else
              echo "ERROR: Neither podman nor docker found"
              exit 1
            fi
          fi

          echo "engine=$ENGINE" >> $GITHUB_OUTPUT
          echo "Using container engine: $ENGINE"

      - name: Install Podman (GitHub Actions)
        if: steps.container-engine.outputs.engine == 'podman' && !contains(github.server_url, 'gitea')
        run: |
          sudo apt-get update
          sudo apt-get -y install podman
          podman version

          # Start podman socket for molecule
          systemctl --user enable --now podman.socket
          systemctl --user status podman.socket || true

          # Set environment for rootless podman
          echo "DOCKER_HOST=unix:///run/user/$(id -u)/podman/podman.sock" >> $GITHUB_ENV

      - name: Verify container engine
        run: |
          ENGINE="${{ steps.container-engine.outputs.engine }}"
          $ENGINE version
          $ENGINE info

      - name: Install pipx
        run: |
          python -m pip install --upgrade pip
          python -m pip install --user pipx
          python -m pipx ensurepath

      - name: Install Ansible and Molecule
        run: |
          pipx install ansible-core==${{ env.ANSIBLE_CORE_VERSION }}
          pipx inject ansible-core molecule
          pipx inject ansible-core "molecule-plugins[podman]"

      - name: Verify installation
        run: |
          ansible --version
          molecule --version

      - name: Run Molecule tests
        run: molecule test
        working-directory: ansible_collections/wzzrd/ghdl/roles/${{ matrix.role }}
        env:
          ANSIBLE_FORCE_COLOR: '1'
          PY_COLORS: '1'

  tag-release:
    name: Tag new release
    runs-on: ubuntu-latest
    needs:
      - lint
      - pytest
      - molecule
    # Only tag on main branch
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect and tag new version
        uses: salsify/action-detect-and-tag-new-version@v2
        with:
          version-command: |
            awk '/^version:/ { print $2 }' galaxy.yml | tr -d '"'
