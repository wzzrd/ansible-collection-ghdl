name: Lint, test and tag

on: push

env:
  # Container engine configuration
  CONTAINER_ENGINE: ${{ vars.CI_CONTAINER_ENGINE || 'podman' }}
  # Version configuration (can be overridden with repository variables)
  ANSIBLE_CORE_VERSION: ${{ vars.ANSIBLE_CORE_VERSION || '2.16.13' }}
  ANSIBLE_LINT_VERSION: ${{ vars.ANSIBLE_LINT_VERSION || '24.9.2' }}
  # Ansible Galaxy configuration for custom servers
  ANSIBLE_GALAXY_SERVER_LIST: ${{ vars.ANSIBLE_GALAXY_SERVER_LIST }}
  ANSIBLE_GALAXY_SERVER_RH_CERTIFIED_URL: ${{ vars.ANSIBLE_GALAXY_SERVER_RH_CERTIFIED_URL }}
  ANSIBLE_GALAXY_SERVER_VALIDATED_URL: ${{ vars.ANSIBLE_GALAXY_SERVER_VALIDATED_URL }}
  ANSIBLE_GALAXY_SERVER_UPSTREAM_URL: ${{ vars.ANSIBLE_GALAXY_SERVER_UPSTREAM_URL }}
  ANSIBLE_GALAXY_SERVER_COMMUNITY_URL: ${{ vars.ANSIBLE_GALAXY_SERVER_COMMUNITY_URL }}
  ANSIBLE_GALAXY_SERVER_LOCAL_URL: ${{ vars.ANSIBLE_GALAXY_SERVER_LOCAL_URL }}
  ANSIBLE_GALAXY_SERVER_RH_CERTIFIED_TOKEN: ${{ secrets.ANSIBLE_GALAXY_SERVER_RH_CERTIFIED_TOKEN }}
  ANSIBLE_GALAXY_SERVER_VALIDATED_TOKEN: ${{ secrets.ANSIBLE_GALAXY_SERVER_VALIDATED_TOKEN }}
  ANSIBLE_GALAXY_SERVER_UPSTREAM_TOKEN: ${{ secrets.ANSIBLE_GALAXY_SERVER_UPSTREAM_TOKEN }}
  ANSIBLE_GALAXY_SERVER_COMMUNITY_TOKEN: ${{ secrets.ANSIBLE_GALAXY_SERVER_COMMUNITY_TOKEN }}
  ANSIBLE_GALAXY_SERVER_LOCAL_TOKEN: ${{ secrets.ANSIBLE_GALAXY_SERVER_LOCAL_TOKEN }}

jobs:
  lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    container:
      image: node:18-bookworm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pipx
        run: apt update && apt -y install pipx

      - name: Install ansible-core
        run: |
          pipx install ansible-core==${{ env.ANSIBLE_CORE_VERSION }}
          # Add pipx bin directory to PATH for subsequent steps
          echo "/root/.local/bin" >> $GITHUB_PATH
        env:
          PIPX_HOME: /root/.local/pipx

      - name: Install ansible-lint
        run: pipx inject --include-apps ansible-core ansible-lint==${{ env.ANSIBLE_LINT_VERSION }}
        env:
          PIPX_HOME: /root/.local/pipx

      - name: Verify installation
        run: |
          ansible --version
          ansible-lint --version

      - name: Run ansible-lint
        run: ansible-lint -v

  pytest:
    name: Unit Tests (pytest)
    runs-on: ubuntu-latest
    container:
      image: node:18-bookworm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pip
        run: apt update && apt -y install python3-pip

      - name: Install test dependencies
        run: pip3 install -r tests/requirements.txt --break-system-packages

      - name: Run pytest
        run: pytest tests/unit/ -v --tb=short --color=yes
        env:
          PYTHONPATH: ${{ github.workspace }}

  molecule:
    name: Integration Tests (Molecule)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        role:
          - starship
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: ansible_collections/wzzrd/ghdl

      - name: Detect and setup container engine
        id: container-engine
        run: |
          ENGINE="${{ env.CONTAINER_ENGINE }}"

          # Auto-detect if not set or set to 'auto'
          if [ "$ENGINE" = "auto" ] || [ -z "$ENGINE" ]; then
            if command -v podman &> /dev/null; then
              ENGINE="podman"
            elif command -v docker &> /dev/null; then
              ENGINE="docker"
            else
              echo "ERROR: Neither podman nor docker found"
              exit 1
            fi
          fi

          echo "engine=$ENGINE" >> $GITHUB_OUTPUT
          echo "Using container engine: $ENGINE"

      - name: Install Podman (GitHub Actions)
        if: steps.container-engine.outputs.engine == 'podman' && !contains(github.server_url, 'gitea')
        run: |
          apt-get update
          apt-get -y install podman

          # Configure XDG RUNTIME DIR
          export XDG_RUNTIME_DIR=/run/user/$(id -u)
          echo "XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR" >> $GITHUB_ENV

          # Create XDG_RUNTIME_DIR if it doesn't exist
          mkdir -p "$XDG_RUNTIME_DIR"
          chmod 700 "$XDG_RUNTIME_DIR"

          podman version

          # Start podman socket for molecule (with proper D-Bus session handling)
          export DBUS_SESSION_BUS_ADDRESS="unix:path=$XDG_RUNTIME_DIR/bus"

          # Try to start with systemd, fallback to manual start if no user session
          if systemctl --user is-system-running &>/dev/null; then
            systemctl --user enable --now podman.socket
            systemctl --user status podman.socket || true
          else
            echo "No systemd user session available, starting podman socket manually"
            podman system service --time=0 unix://$XDG_RUNTIME_DIR/podman/podman.sock &
            sleep 2
          fi

          # Set environment for rootless podman
          echo "DOCKER_HOST=unix://$XDG_RUNTIME_DIR/podman/podman.sock" >> $GITHUB_ENV

      - name: Verify container engine
        run: |
          ENGINE="${{ steps.container-engine.outputs.engine }}"
          $ENGINE version
          $ENGINE info

      - name: Install Python and pipx
        run: |
          apt-get update
          apt-get -y install python3 python3-pip pipx

      - name: Install Ansible and Molecule
        run: |
          pipx install ansible-core==${{ env.ANSIBLE_CORE_VERSION }}
          pipx inject --include-apps ansible-core molecule
          pipx inject ansible-core "molecule-plugins[podman]"

          # Add pipx bin directory to PATH for subsequent steps
          echo "/usr/local/bin" >> $GITHUB_PATH
        env:
          PIPX_HOME: /opt/pipx
          PIPX_BIN_DIR: /usr/local/bin

      - name: Verify installation
        run: |
          ansible --version
          molecule --version

      - name: Run Molecule tests
        run: molecule test
        working-directory: ansible_collections/wzzrd/ghdl/roles/${{ matrix.role }}
        env:
          ANSIBLE_FORCE_COLOR: '1'
          PY_COLORS: '1'
          ANSIBLE_COLLECTIONS_PATH: ${{ github.workspace }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  tag-release:
    name: Tag new release
    runs-on: ubuntu-latest
    needs:
      - lint
      - pytest
      - molecule
    # Only tag on main branch
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect and tag new version
        uses: salsify/action-detect-and-tag-new-version@v2
        with:
          version-command: |
            awk '/^version:/ { print $2 }' galaxy.yml | tr -d '"'
