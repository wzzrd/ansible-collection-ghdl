---
- name: Clear all checksum-related variables from previous iterations
  ansible.builtin.set_fact:
    binary_checksum: ""
    checksum_file_content: ""
    checksum_lines: []
    checksum_line: ""
    binary_hash: ""

- name: Check if checksum file already downloaded
  ansible.builtin.stat:
    path: "{{ downloader_tmp_dir }}/CHECKSUMS"
  register: checksum_file_exists
  when: checksum_file_url | length > 0
  delegate_to: localhost
  become: false

- name: Download checksum file to localhost
  ansible.builtin.get_url:
    url: "{{ checksum_file_url }}"
    dest: "{{ downloader_tmp_dir }}/CHECKSUMS"
    mode: '0600'
  register: checksum_download
  when:
    - checksum_file_url | length > 0
    - not checksum_file_exists.stat.exists
  delegate_to: localhost
  become: false
  throttle: 1

- name: Set checksum_download for skipped hosts
  ansible.builtin.set_fact:
    checksum_download:
      skipped: false
  when:
    - checksum_file_url | length > 0
    - checksum_file_exists.stat.exists

- name: Read checksum file from localhost
  ansible.builtin.slurp:
    src: "{{ downloader_tmp_dir }}/CHECKSUMS"
  register: checksum_file_content
  when:
    - checksum_file_url | length > 0
    - checksum_file_exists.stat.exists or (checksum_download is succeeded and checksum_download is not skipped)
  delegate_to: localhost
  become: false

- name: Extract binary filename from download URL
  ansible.builtin.set_fact:
    binary_filename: "{{ result_url | basename }}"

- name: Debug binary filename
  ansible.builtin.debug:
    msg: "Looking for checksum for: {{ binary_filename }}"
  when:
    - downloader_debug | default(false)
    - checksum_file_url | length > 0

- name: Split checksum file into lines
  ansible.builtin.set_fact:
    checksum_lines: "{{ (checksum_file_content.content | b64decode).split('\n') }}"
  when: checksum_file_content is defined and checksum_file_content.content is defined

- name: Find matching checksum line
  ansible.builtin.set_fact:
    checksum_line: "{{ checksum_lines | select('search', binary_filename) | list | first | default('') }}"
  when: checksum_lines is defined

- name: Debug matched line
  ansible.builtin.debug:
    msg: "Matched line: {{ checksum_line }}"
  when:
    - downloader_debug | default(false)
    - checksum_line is defined

- name: Extract hash from matching line
  ansible.builtin.set_fact:
    binary_hash: "{{ checksum_line.split() | first | default('') }}"
  when: checksum_line is defined and checksum_line | length > 0

- name: Set checksum for download verification
  ansible.builtin.set_fact:
    binary_checksum: "sha256:{{ binary_hash }}"
  when: binary_hash is defined and binary_hash | length > 0

- name: Show checksum that will be used
  ansible.builtin.debug:
    msg: "Will verify download with: {{ binary_checksum | default('no checksum - skipping verification') }}"
  when: downloader_debug | default(false)

- name: Warn if no checksum found
  ansible.builtin.debug:
    msg: "WARNING: No checksum file found for {{ downloader_project }}. Download will not be verified."
  when: checksum_file_url | length == 0 or binary_hash is not defined or binary_hash | length == 0
